---
title: 12. The 4-Way Handshake
updated: 2025-09-13 19:19:59Z
created: 2025-09-13 19:18:23Z
---

# The 4-Way Handshake (WPA/WPA2/WPA3)

## Purpose

The 4-Way Handshake happens **after authentication** (when a client connects with a password/PSK or enterprise credentials).  
It serves to:

1.  Prove that **both client and AP know the secret key** (derived from the Wi-Fi password or enterprise authentication).
    
2.  Generate **session keys** used to encrypt traffic.
    
3.  Protect against **replay attacks** using nonces (random numbers used once).
    

* * *

## Key Components

- **PMK (Pairwise Master Key):**
    
    - Root key derived from the Wi-Fi password (PSK) or from the authentication server in WPA-Enterprise.
        
    - Both AP and client already share this before the handshake.
        
- **ANonce (AP Nonce):** Random value generated by the Access Point.
    
- **SNonce (Supplicant Nonce):** Random value generated by the Client (supplicant).
    
- **PTK (Pairwise Transient Key):** Derived from PMK + ANonce + SNonce + MAC addresses.
    
    - Ensures each session key is unique.

* * *

## The Four Steps

1.  **Message 1 (AP → Client)**
    
    - AP sends **ANonce** (random number).
        
    - Purpose: start the handshake and provide input for key generation.
        
2.  **Message 2 (Client → AP)**
    
    - Client generates **SNonce**.
        
    - Uses PMK, ANonce, SNonce, and both MAC addresses to compute the **PTK**.
        
    - Sends SNonce + MIC (Message Integrity Code) to AP (proving knowledge of PMK).
        
3.  **Message 3 (AP → Client)**
    
    - AP now has ANonce + SNonce, so it can compute the **same PTK**.
        
    - AP installs the PTK and sends a message containing GTK (Group Temporal Key) + MIC.
        
    - Purpose: distribute broadcast/multicast key securely.
        
4.  **Message 4 (Client → AP)**
    
    - Client installs the PTK and GTK.
        
    - Sends an ACK to AP.
        
    - Handshake is complete, and encrypted communication begins.
        

* * *

## Visualization

```
AP (Authenticator)                       Client (Supplicant)
-------------------------------------------------------------
1. ANonce ----------------------------->  
                     Generate SNonce, derive PTK
2. SNonce + MIC <-----------------------
   (proves possession of PMK) 

   Derive PTK, install it
3. GTK + MIC --------------------------->
   (secure group key transfer)

   Install PTK + GTK
4. ACK --------------------------------->
   (handshake complete, encryption ready)

```

* * *

## Why It Matters for Security

- **Handshake capture**: Attackers performing deauth attacks force clients to reconnect, allowing them to capture the 4-way handshake.
    
- **Offline cracking**: With the handshake, attackers try to guess the Wi-Fi password offline by testing passphrases against the PMK derivation.
    
- **Protections**: WPA3 introduces **SAE (Simultaneous Authentication of Equals)** to resist offline cracking.
    

* * *

In short:  
The 4-way handshake ensures **fresh session keys** for every connection, proves both sides know the Wi-Fi secret, and prevents replay attacks. But if an attacker captures it, they can attempt **offline brute-force/dictionary attacks** against weak passwords.

&nbsp;

# The 4-Way Handshake in WPA/WPA2/WPA3

## WPA (Wi-Fi Protected Access, 2003)

- The handshake was introduced here for the first time.
    
- Uses **TKIP (Temporal Key Integrity Protocol)** to derive encryption keys.
    
- Still relies on the 4-Way Handshake to turn the **PMK** into a **PTK** (session key).
    
- Now considered insecure because TKIP is deprecated.
    

* * *

## WPA2 (2004 – Present, most common)

- The 4-Way Handshake is used with **AES-CCMP** encryption (much stronger than TKIP).
    
- The process is the same:
    
    - Both sides prove they know the **PMK** (from PSK or 802.1X).
        
    - They exchange nonces to generate the **PTK** and distribute the **GTK**.
        
- This is what attackers target when they capture a handshake to try dictionary/brute-force attacks on Wi-Fi passwords.
    

* * *

## WPA3 (2018 – Present)

- Still uses a **4-Way Handshake** for session key establishment.
    
- Major difference: it replaces PSK with **SAE (Simultaneous Authentication of Equals)** before the handshake.
    
    - SAE resists offline dictionary attacks.
        
    - Only after SAE succeeds, the **PMK** is created and then the **4-Way Handshake** runs (just like in WPA2).
        

* * *

The **4-Way Handshake is used in WPA, WPA2, and WPA3**.

- WPA used it with TKIP.
    
- WPA2 uses it with AES-CCMP (standard today).
    
- WPA3 still uses it, but paired with **SAE** for stronger authentication.
    

* * *

&nbsp;