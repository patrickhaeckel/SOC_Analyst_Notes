---
title: 04. Advanced Behavior Based Hunting
updated: 2025-08-24 21:53:16Z
created: 2025-08-24 18:51:11Z
---

### 1) Z-Score spike per process (stricter than 0.5\*stdev)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=1h| stats count as NetworkConnections by _time, Image| eventstats avg(NetworkConnections) as avg stdev(NetworkConnections) as stdev by Image| eval z=if(stdev>0,(NetworkConnections-avg)/stdev,0)| where z>=2 /* try 2.5 or 3 to cut FPs */
```

### 2) Robust baseline with MAD (median absolute deviation)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=1h| stats count as n by _time, Image| eventstats median(n) as med by Image| eval dev=abs(n-med)| eventstats median(dev) as mad by Image| eval isOutlier=if(mad>0 AND n > med + (3*1.4826*mad), 1, 0) /* 3*MAD */| search isOutlier=1
```

### 3) Percent-change burst vs last hour (per process)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=1h| stats count as n by Image, _time| sort Image _time| streamstats current=f last(n) as prev by Image| eval pct_change=if(prev>0, (n-prev)/prev*100, 999)| where pct_change>=200 /* 200%+ jump */
```

### 4) EWMA (exponential moving average) surge detector

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=1h| stats count as n by Image, _time| sort Image _time| streamstats window=100 current=t first(n) as ewma by Image| eval alpha=0.3| streamstats current=t eval ewma=round(alpha*n + (1-alpha)*coalesce(ewma, n),2) by Image| eval isOutlier=if(n > ewma*2, 1, 0) /* 2x EWMA */| search isOutlier=1
```

### 5) Spike in **unique destinations** per process

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=1h| stats dc(DestinationIp) as uniq_dests by Image, _time| eventstats avg(uniq_dests) as avg stdev(uniq_dests) as sd by Image| eval isOutlier=if(uniq_dests > avg + 2*sd, 1, 0)| search isOutlier=1
```

### 6) Beaconing regularity (low jitter) by proc→dest

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| stats earliest(_time) as first latest(_time) as last values(_time) as hits by Image, DestinationIp| mvsort(hits)| eval intervals=mvrange(0, mvcount(hits)-1)| eval deltas=mvzip(mvindex(hits,1,999999), mvindex(hits,0,999998), "§")| eval deltas=mvmap(deltas, abs(substr(split(deltas,"§")/1,1) - substr(split(deltas,"§")/1,0)))| eval mean=mvavg(deltas), stdev=mvstdev(deltas)| where mvcount(deltas)>=5 AND stdev<120 /* ~regular <2m jitter */
```

### 7) New (never-before-seen) process making network calls

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| stats min(_time) as firstSeen max(_time) as lastSeen count by Image| where firstSeen >= relative_time(now(), "-24h") /* first seen in 24h */
```

### 8) New parent→child network activity (rare chain)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| stats count by ParentImage, Image, DestinationIp, DestinationPort| where count=1 /* truly rare combo */
```

### 9) Port rarity per process (unusual service ports)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| stats count by Image, DestinationPort| eventstats avg(count) as avg stdev(count) as sd by Image| eval rarity=if(sd>0,(avg-count)/sd,0)| where rarity>1.5 AND DestinationPort>=1024
```

### 10) Host-to-host fan-out (possible lateral scan)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=30m| stats dc(DestinationIp) as uniq_targets by _time, ComputerName| eventstats avg(uniq_targets) as avg stdev(uniq_targets) as sd by ComputerName| eval spike=uniq_targets > avg + 2*sd| search spike=1
```

### 11) Suspicious **command-line netcon** burst (proc args)

```
index="main" sourcetype="WinEventLog:Sysmon" (EventCode=1 OR EventCode=3)| bin _time span=1h| stats count(eval(EventCode=3)) as conns values(CommandLine) as cmd by _time, Image| eventstats avg(conns) as avg stdev(conns) as sd by Image| eval isOutlier=conns > avg + 2*sd| where isOutlier=1 AND like(lower(mvjoin(cmd," ")),"%download%") OR like(lower(mvjoin(cmd," ")),"%invoke-webrequest%")
```

### 12) Day-of-week + hour-of-day baseline (seasonality aware)

```
index="main" sourcetype="WinEventLog:Sysmon" EventCode=3| bin _time span=1h| eval dow=strftime(_time,"%a"), hod=strftime(_time,"%H")| stats count as n by Image, dow, hod| eventstats avg(n) as avg stdev(n) as sd by Image, dow, hod| eval isOutlier=if(n > avg + 2*sd, 1, 0)| search isOutlier=1
```

* * *

## Quick knobs to reduce false positives

- Increase thresholds: `+ 2*stdev`, `z>=3`, `3*MAD`.
    
- Use **`by Image, ComputerName`** to baseline per host and process.
    
- Extend windows: `time_window=48h` or larger bins (`span=2h`) for noisy environments.
    
- Post-filter known chatty procs (browsers, AV) with `NOT (Image="*chrome.exe" OR Image="*MsMpEng.exe")`.
    

&nbsp;