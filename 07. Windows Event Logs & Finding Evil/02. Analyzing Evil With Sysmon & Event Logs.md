---
title: 02. Analyzing Evil With Sysmon & Event Logs
updated: 2025-08-15 00:57:20Z
created: 2025-08-15 00:29:55Z
---

**LSASS stands for Local Security Authority Subsystem Service. It's a crucial process in Microsoft Windows operating systems responsible for enforcing the system's security policy**

## **Sysmon for Threat Detection: Practical Overview**

### **1\. What is Sysmon?**

**System Monitor (Sysmon)** is part of Microsoft Sysinternals, running as a Windows service and device driver that logs detailed system activity to the Windows Event Log.  
It **persists across reboots** and provides telemetry useful for incident response and threat hunting.

**Core capabilities:**

- Process creation with command-line arguments.
    
- Network connection logging.
    
- File creation time changes.
    
- Module (DLL) loads.
    
- Process memory access events.
    
- And more, depending on configuration.
    

* * *

### **2\. Installing Sysmon**

1.  Download from [Microsoft Sysinternals](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon).
    
2.  Open an elevated command prompt.
    
3.  Basic install example:
    

- `sysmon.exe -i -accepteula -h md5,sha256,imphash -l -n`
    
- Use a recommended configuration for filtering and structure:
    
    - [SwiftOnSecurity Sysmon Config](https://github.com/SwiftOnSecurity/sysmon-config) – Comprehensive, well-maintained.
        
    - [Olaf Hartong Sysmon Modular](https://github.com/olafhartong/sysmon-modular) – Modular, customizable.
        
    
    Apply configuration:
    

1.  `sysmon.exe -c sysmonconfig-export.xml`

* * *

### **3\. Event IDs to Know for Detection**

| **Event ID** | **Name** | **Purpose** | **Use Cases** |
| --- | --- | --- | --- |
| 1   | Process Creation | Command-line args, hashes, parent/child links | Malware execution, suspicious script launches |
| 3   | Network Connection | Outbound/Inbound connections | C2 detection, data exfiltration |
| 7   | Image Load | DLL/module loads | DLL hijacking, code injection |
| 10  | Process Access | Memory/process handle access | Credential dumping, process injection |
| 13  | Registry Modification | Critical registry changes | Persistence, privilege escalation |

* * *

### **4\. Detection Scenarios & Insights**

#### **A. DLL Hijacking**

**Attack Description:**  
Legitimate executables load attacker-controlled DLLs instead of the real, signed ones, often by placing a malicious DLL in the same directory as the target executable.

**Sysmon Event to Monitor:**

- **Event ID 7 – Image Load**

**Key IOCs:**

1.  Legitimate EXE in **unexpected writable directories** (e.g., Desktop, Downloads).
    
2.  DLL normally loaded from **System32** appearing in non-standard paths.
    
3.  Unsigned DLL where the original is Microsoft-signed.
    

* * *

#### **B. Unmanaged PowerShell / C# Injection**

**Attack Description:**  
Injecting unmanaged PowerShell-like code or C# assemblies into processes that do not typically run managed (.NET) code.

**Sysmon Event to Monitor:**

- **Event ID 7 – Image Load** (Look for `clr.dll` or `clrjit.dll` in unusual processes.)

**Key IOCs:**

1.  `clr.dll` or `clrjit.dll` loaded in non-.NET processes (e.g., spoolsv.exe, lsass.exe, svchost.exe).
    
2.  Sudden transition of a process from unmanaged to managed state without a legitimate reason.
    
3.  Managed runtime DLLs loaded from unusual locations.
    

* * *

#### **C. Credential Dumping (e.g., Mimikatz)**

**Attack Description:**  
Malware or tools attempt to access LSASS process memory to extract password hashes or plaintext credentials.

**Sysmon Event to Monitor:**

- **Event ID 10 – Process Access**

**Key IOCs:**

1.  Non-security tool processes attempting to access `lsass.exe`.
    
2.  Source process from unexpected directories (e.g., `Downloads\AgentEXE.exe`).
    
3.  **SourceUser ≠ TargetUser** — indicates cross-privilege process access.
    
4.  Request for **SeDebugPrivilege** outside of legitimate debugging scenarios.
    

* * *

### **5\. Analyst Tips**

- **Event 7** and **Event 10** combined give deep insight into code injection and credential theft attempts.
    
- Use Sysmon config to **reduce noise** and focus on unusual processes and paths.
    
- Always correlate Sysmon events with **Security Log events** (e.g., 4624 logon patterns) for richer context.
    
- **Whitelist** known good processes and paths to avoid false positives.
    

&nbsp;

* * *

# Sysmon install & config nuances

- **Event coverage toggles:**
    
    - **Image load (Event ID 7)** is **off by default** and only turns on if you enable it (traditionally via the `-l` switch at install). If you don’t see 7s, that’s usually why. It’s very chatty, so plan filters.
        
    - **Network connections (Event ID 3)** are also **off by default**; enable explicitly in your config if you need them.
        
- **Hashing:** SHA-1 is the historical default; you can enable **multiple hashes** (e.g., `-h md5,sha256,imphash`) and they’ll be written right into the events for stable dedup and triage.
    
- **Include vs. exclude logic (easy to mix up):**
    
    - `onmatch="exclude"` with **no rules** ⇒ nothing is excluded ⇒ **log everything** for that event type.
        
    - `onmatch="include"` with **no rules** ⇒ nothing matches ⇒ **log nothing** for that event type.
        
- **Hardening note:** The **Sysmon service runs as a protected process**, which helps resist tampering. Still forward logs off-host ASAP.
    

&nbsp;

* * *

### DLL hijacking (Sysmon Event ID 7)

- **Case isn’t a signal:** Windows file lookups are case-insensitive, so `WININET.dll` vs `wininet.dll` isn’t by itself suspicious. Focus on **path, signature, and parent**. (General Windows behavior; keep your rules path-centric.)
    
- **What to key on (low-noise):**
    
    - **`ImageLoaded` path not under `System32\`** **AND** `SignatureStatus != Valid` for DLLs that *should* be Microsoft-signed.
        
    - **`Image` path (the EXE)** not under **`System32\`/`SysWOW64\`** when you expect it to live there (e.g., `calc.exe` copies).
        
    - Add allow-lists for apps known to carry private DLLs (legit app-local side-by-side).
        
- **Why you might miss it:** If Event 7 isn’t enabled (see first section), you’ll replicate the hijack but **see no Event 7s** — this trips a lot of labs.
    
- **Backgrounders:** concise primers on DLL search-order hijack mechanics (good for analyst onboarding).
    

&nbsp;

* * *

### Unmanaged PowerShell / C# execute-assembly — extra telemetry

- **Corroborate with Sysmon:** Look for **`clr.dll`/`clrjit.dll`** **ImageLoad (ID 7)** in processes that aren’t typically .NET hosts (e.g., `spoolsv.exe`). That’s a **solid execute-assembly clue**.
    
- **Windows logging to add (reduces blind spots):**
    
    - **PowerShell Script Block Logging (4104)** and **Module Logging (4103)** under `Microsoft-Windows-PowerShell/Operational`. For **PowerShell 7+**, also check `PowerShellCore/Operational`. Enable via GPO (Script Block Logging + Module Logging).
- **Extra Sysmon signal:** **CreateRemoteThread (ID 8)** can light up classic injection paths preceding “managed” pivots; consider enabling and filtering
    

&nbsp;

* * *

### Credential dumping (LSASS) — precision filters & exceptions

- **Why Event 10 is gold:** **ProcessAccess (ID 10)** fires when one process opens another — perfect for catching **LSASS memory reads**.
    
- **Fields that matter most:**
    
    - **`TargetImage`** = `\lsass.exe`
        
    - **`SourceImage`** (what’s doing it)
        
    - **`GrantedAccess`** (access mask) — suspicious values often include **`0x10` (VM_READ)**, **`0x1410` (QUERY_LIMITED_INFO + VM_READ)**, or **very broad masks like `0x1fffff`**. Filter to **non-SYSTEM** users first.
        
- **Call-stack clue:** If you log **call stacks**, seeing **`dbghelp.dll`/`dbgcore.dll`** in the trace is a strong hint of a memory dump path (e.g., ProcDump pattern).
    
- **Legit talkers to LSASS:** AV/EDR, credential providers, and OS internals will access LSASS. Build an **allow-list** for those to keep alerts clean. (Microsoft’s Event 10 guidance explicitly calls out LSASS theft use-cases; use that as rationale.)
    
- **Environment caveats:** If **LSASS is PPL/Credential Guard-protected**, many user-mode dump attempts simply fail — you might still see the **attempt** (Event 10 with Access Denied), but offensive tooling shifts to drivers. Watch **Sysmon Driver Load (ID 6)** for unsigned/suspect drivers.