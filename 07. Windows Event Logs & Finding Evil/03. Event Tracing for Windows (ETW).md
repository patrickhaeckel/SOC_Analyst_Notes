---
title: 03. Event Tracing for Windows (ETW)
updated: 2025-08-15 00:29:54Z
created: 2025-08-14 23:59:53Z
---

## **Interacting with ETW (Event Tracing for Windows)**

### **What ETW Is**

Event Tracing for Windows (ETW) is a high-performance logging system built into Windows. It collects diagnostic and operational data from various components of the OS and applications using *providers* (sources of events).

## **ETW Architecture ‚Äì Key Components**

ETW uses a **publish-subscribe model**, meaning providers create events, and consumers subscribe to them. Between them, controllers manage the sessions and channels organize the flow.

* * *

### **1\. Controllers** ‚Äì *The Session Managers*

- Start and stop **trace sessions**.
    
- Enable or disable **event providers** within a session.
    
- A single session can subscribe to multiple providers.
    
- **Example tool:** `logman.exe` (built into Windows).
    
- Think of controllers as the **remote control** for ETW logging.
    

* * *

### **2\. Providers** ‚Äì *The Event Generators*

Providers create and send events to active ETW sessions. They can run in **kernel mode** or **user mode**.  
**Types of providers:**

1.  **MOF Providers**
    
    - Based on *Managed Object Format* (MOF) schemas.
        
    - Flexible, often used for system monitoring.
        
2.  **WPP Providers** (*Windows Software Trace Preprocessor*)
    
    - Use macros in source code to generate events.
        
    - Common in low-level, kernel-mode debugging.
        
3.  **Manifest-based Providers**
    
    - Use XML manifests to define events.
        
    - Easier to manage and customize.
        
4.  **TraceLogging Providers**
    
    - Use the TraceLogging API (modern, lightweight).
        
    - Minimal coding needed for event generation.
        

* * *

### **3\. Consumers** ‚Äì *The Event Readers*

- Subscribe to events and process them.
    
- Can write events to **.ETL files** or consume them in real time using APIs.
    
- Example: Security monitoring tools, PowerShell (`Get-WinEvent`).
    

* * *

### **4\. Channels** ‚Äì *Event Organizers*

- Logical containers for events based on category or importance.
    
- Allow selective subscription so consumers only get relevant events.
    
- Only events with a **Channel property** can appear in the Event Log.
    

* * *

### **5\. ETL Files** ‚Äì *The Event Storage*

- **Event Trace Log (ETL)** files store events on disk for offline analysis or archiving.
    
- Support rotation and size limits to avoid storage issues.
    
- Useful for forensics and long-term monitoring.
    

* * *

### **Important Notes**

- Some providers are disabled by default because they produce large amounts of data.
    
- ETW is extensible ‚Äî you can build **custom providers**.
    
- Kernel-mode and user-mode providers are both supported.
    

&nbsp;

You can manage ETW using the built-in `logman.exe` utility, which allows you to:

- **List active tracing sessions**
    
- **Start/stop custom sessions**
    
- **Inspect provider details**
    
- **Filter event capture by keywords or levels**
    

* * *

### **Why SOC Analysts and DFIR Care**

- **Identify ongoing logging sources** ‚Äî Spot unusual ETW sessions created by malware or suspicious software.
    
- **Access raw trace data** ‚Äî Find providers that may have captured valuable evidence (e.g., process creation, logon events, file access).
    
- **Correlate with Event Viewer logs** ‚Äî Some ETW providers log data that never makes it into standard Event Viewer channels.
    

* * *

## **1\. Viewing Active ETW Sessions**

To see all running ETW sessions across the system:

```ps
logman query -ets

```

The `-ets` flag means *Event Trace Sessions*. Without it, `logman` will only query locally saved Data Collector Sets, not live sessions.

Example output:

```ps
Data Collector Set                      Type     Status
--------------------------------------------------------
Circular Kernel Context Logger          Trace    Running
Eventlog-Security                       Trace    Running
DiagLog                                 Trace    Running
Diagtrack-Listener                      Trace    Running

```

* * *

## **2\. Inspecting a Specific Session**

You can view detailed information about a session like **max log size**, **log location**, and **providers** it‚Äôs subscribed to:

```ps
logman query "EventLog-System" -ets
```

You‚Äôll see:

- **Name & Status** ‚Äî Identifies the session and whether it‚Äôs running
    
- **Root Path** ‚Äî Where logs are stored
    
- **Buffer settings** ‚Äî Important for understanding performance impact
    
- **Providers** ‚Äî Each with:
    
    - **Name & GUID** ‚Äî Unique identifier
        
    - **Level** ‚Äî Which severities are captured (Error, Warning, Information, etc.)
        
    - **KeywordsAny / KeywordsAll** ‚Äî Filters by event category
        

* * *

## **3\. Listing All Providers**

To see every ETW provider on the system:

```txt
logman query providers
```

Example:

```
Provider                                 GUID
-------------------------------------------------------------
Microsoft-Windows-Winlogon               {DBE9B383-7CF3-4331-91CC-A3CB16A3B538}
...

```

üí° *Windows 10+ ships with over 1,000 providers. Third-party applications and drivers may also register their own.*

You can filter results to find a specific provider:

```txt
logman query providers | findstr "Winlogon"
```

* * *

## **4\. Inspecting a Provider**

Once you‚Äôve identified a provider of interest:

```txt
logman query providers Microsoft-Windows-Winlogon
```

You‚Äôll get:

- **Keywords** ‚Äî Categories of events you can enable (e.g., `System`, `Operational`, `Telemetry`).
    
- **Levels** ‚Äî Error, Warning, Informational.
    
- **PIDs** ‚Äî Processes currently using this provider.
    

Example keywords:

```txt
0x8000000000000000  Microsoft-Windows-Winlogon/Diagnostic
0x4000000000000000  Microsoft-Windows-Winlogon/Operational
0x2000000000000000  System

```

These correspond to specific Event Viewer channels.

* * *

## **Key:**

- `logman query -ets` ‚Üí See if malicious tools have spawned their own ETW sessions.
    
- Inspect suspicious sessions to see which **providers** they‚Äôre capturing.
    
- Some malware disables or hijacks ETW providers ‚Äî checking them can reveal tampering.
    
- Knowing provider keywords and levels allows you to set up **custom trace sessions** to capture targeted events during investigations.
    

* * *

&nbsp;

## **ETW &¬†`logman` Quick Reference**

&nbsp;

| Purpose | Command | Notes |
| --- | --- | --- |
| **List all active Event Trace Sessions** | `logman query -ets` | `-ets` ‚Üí Shows live ETW sessions (system-wide). Look for unusual or unknown sessions. |
| **Inspect a specific session** | `logman query "EventLog-System" -ets` | Shows status, log path, buffer settings, and providers in the session. |
| **List all providers** | `logman query providers` | Returns every ETW provider with its GUID. Large output filtered with¬†`findstr`. |
| **Find a specific provider** | `logman query providers \| findstr "Winlogon"` | Filters provider list for keyword `"Winlogon"`. |
| **Inspect a provider** | `logman query providers Microsoft-Windows-Winlogon` | Lists keywords, event levels, and PIDs using the provider. |
| **Create a new trace session** | `logman create trace "<SessionName>" -p "<ProviderName>" -o <PathToETL> -ets` Example: `logman create trace MyTrace -p "Microsoft-Windows-Winlogon" -o C:\Logs\winlogon.etl -ets` | **`-p`** ‚Üí Provider name **`-o`** ‚Üí Output file (.etl) **`-ets`** ‚Üí Start immediately |
| **Stop a trace session** | `logman stop "<SessionName>" -ets` | Stops the given session immediately. |
| **Delete a trace session** | `logman delete "<SessionName>"` | Permanently removes the session. |

**Start targeted collection**

- `logman create trace MyTrace -p "<ProviderName>" -o C:\Logs\trace.etl -ets`

&nbsp;

### 1Ô∏è‚É£ **Logman creates the trace session**

- The `create trace` command tells Logman to define a new ETW trace session named `MyTrace`.
    
- Since you used `-ets` (Event Trace Session), it starts *immediately* rather than just creating the configuration.
    

### 2Ô∏è‚É£¬†**The provider is enabled**

- The `-p "<ProviderName>"` option means you‚Äôre targeting a **single ETW provider**.
    
- That provider is identified internally by a GUID, but Logman lets you use its name if it‚Äôs registered in the system.
    
- Once enabled, the provider begins generating its events and sending them to the ETW session buffer.
    

### 3Ô∏è‚É£¬†**Kernel buffers store the events temporarily**

- ETW uses in-memory buffers to collect the events coming from the provider.
    
- These buffers get periodically flushed to your `.etl` file at `C:\Logs\trace.etl`.
    

### 4Ô∏è‚É£¬†**The `.etl` file is written in binary**

- The file isn‚Äôt plain text‚Äîit‚Äôs an **Event Trace Log** format file.
    
- You can open it later with tools like **Event Viewer (via ‚ÄúOpen Saved Log‚Äù)**, **PerfView**, or **Windows Performance Analyzer**.
    
- The binary format is space-efficient and designed for high-speed logging.
    

### 5Ô∏è‚É£¬†**Session runs until you stop it**

- The trace will keep recording until you run:

&nbsp;

* * *

## **GUI-Based Alternatives for Interacting with ETW**

While `logman.exe` is the go-to command-line utility, there are graphical tools that make ETW session management more intuitive:

### **1\. Performance Monitor (PerfMon)**

- **Location:** `perfmon.exe`
    
- **View Sessions:**
    
    - Navigate to: **Data Collector Sets ‚Üí Event Trace Sessions**
        
    - Lists active and saved trace sessions.
        
- **Inspect Details:**
    
    - Double-click a session to view:
        
        - Subscribed providers
            
        - Enabled keywords/levels
            
        - Trace configuration
            
- **Modify a Session:**
    
    - Add or remove providers directly in the UI.
- **Create New Sessions:**
    
    - Go to **User Defined** ‚Üí right-click ‚Üí **New** ‚Üí **Data Collector Set**
        
    - Choose **Event Trace Data Collector** and configure providers, filters, and log location.
        

* * *

### **2\. EtwExplorer (Third-Party Tool)**

- **Purpose:** Browse ETW provider metadata.
    
- **Features:**
    
    - Search providers by name or GUID.
        
    - View available keywords, levels, and event schemas.
        
    - Helpful for reverse engineering provider functionality.
        

* * *

## **High-Value ETW Providers for Security Monitoring**

| **Provider** | **Primary Use** |
| --- | --- |
| Microsoft-Windows-Kernel-Process | Process creation, injection, hollowing, APT activity. |
| Microsoft-Windows-Kernel-File | Unauthorized file access, ransomware detection. |
| Microsoft-Windows-Kernel-Network | Network activity at kernel level (exfiltration, C2). |
| Microsoft-Windows-SMBClient / SMBServer | SMB traffic analysis, lateral movement detection. |
| Microsoft-Windows-DotNETRuntime | Malicious .NET assemblies, exploitation attempts. |
| OpenSSH | SSH login attempts, brute force detection. |
| Microsoft-Windows-VPN-Client | Suspicious VPN connections. |
| Microsoft-Windows-PowerShell | Script block logging, PowerShell abuse. |
| Microsoft-Windows-Kernel-Registry | Persistence and registry modifications. |
| Microsoft-Windows-CodeIntegrity | Unsigned or malicious driver loading. |
| Microsoft-Antimalware-Service | Disabled AV services, evasion attempts. |
| WinRM | Unauthorized remote management activity. |
| Microsoft-Windows-TerminalServices-LocalSessionManager | RDP activity monitoring. |
| Microsoft-Windows-Security-Mitigations | Bypass attempts of OS security mitigations. |
| Microsoft-Windows-DNS-Client | DNS tunneling, C2 DNS requests. |
| Microsoft-Antimalware-Protection | AV configuration changes or disabling. |

* * *

## **Restricted Providers**

**1Ô∏è‚É£ What‚Äôs a ‚Äúrestricted‚Äù ETW provider?**

- Normally, any ETW provider can be subscribed to if you know its name or GUID.
    
- **Restricted providers** are *locked down* by Windows so only trusted, privileged processes can collect from them.
    
- Example:  
    `Microsoft-Windows-Threat-Intelligence`  
    This is used internally by Defender and other security products to collect very sensitive attack data.
    

**2Ô∏è‚É£ Why the restriction exists**

These providers log **deep system and security telemetry**:

- Origin of threats (e.g., file hashes, network indicators, process lineage)
    
- Exact system modifications (e.g., registry changes, driver loads, injection attempts)
    
- Could be abused by attackers if they could freely subscribe ‚Äî they‚Äôd get insight into detection logic and bypass methods.
    

So Microsoft requires **strict access control**.

**3Ô∏è‚É£ How you get access legitimately**

A process must run as a **Protected Process Light (PPL)** ‚Äî this is a special Windows process protection mode used for anti-malware software.

To be allowed:

1.  **Apply to Microsoft** ‚Üí They verify your company identity.
    
2.  **Sign legal agreements** ‚Üí To ensure you won‚Äôt abuse the telemetry.
    
3.  **Implement an ELAM driver** (Early Launch Anti-Malware) ‚Üí Lets your AV product load before other drivers at boot.
    
4.  **Pass Microsoft testing** ‚Üí Your code must be Authenticode-signed and meet stability/security standards.
    

Once approved, your process can start ETW sessions for restricted providers.

**4Ô∏è‚É£ Why it‚Äôs valuable for defenders**

- Gives *extremely detailed* forensic data on threats.
    
- Lets security tools **detect advanced attacks in real time** without needing custom kernel hooks.
    
- Tracks **who**, **what**, **where**, **when** of suspicious activity.
    

**5Ô∏è‚É£ What about ‚Äúworkarounds‚Äù**

- Some researchers and attackers have found ways to get data from restricted providers without being approved, usually by:
    
    - Running in **kernel mode**.
        
    - Using **debug privileges** to patch ETW security descriptors.
        
    - Hooking into processes that *already* have access.
        
- These are not supported and usually violate security policy ‚Äî and in a production environment, they can trip security alerts.
    

* * *

- GUI tools like PerfMon make session discovery and provider inspection¬†**faster during live investigations**.
    
- Providers give **fine-grained visibility** into OS and application activity not available via Event Viewer alone.
    
- Restricted providers can be **gold mines** for advanced threat detection, but require special access.
    

* * *

&nbsp;