---
title: 08. Intrusion Detection With Zeek
updated: 2025-09-26 05:43:40Z
created: 2025-09-26 04:27:59Z
---

# Intrusion Detection With Zeek

Zeek (formerly Bro) is a powerful framework for network security monitoring. Instead of focusing on raw packets, Zeek generates structured logs that summarize network activity in detail. These logs allow us to analyze connections, DNS requests, SSL handshakes, file transfers, and much more.

Because Zeek is scriptable and flexible, defenders can adapt it to detect many different kinds of suspicious or malicious behavior. Let’s walk through several examples of how Zeek can help us uncover intrusions, and we’ll explain the key commands and logs used along the way.

* * *

## Example 1: Detecting Beaconing Malware

**Beaconing** refers to malware contacting its command-and-control (C2) server on a repeating schedule, usually every few seconds or minutes. The `conn.log` file that Zeek generates is perfect for spotting this.

`cat conn.log`

- **What it does**: Displays all recorded network connections. Each entry includes timestamps, source/destination IPs and ports, protocol, duration, and byte counts.

**How to detect beaconing:**

- Look for repeated connections from one internal host to the same external server.
    
- Check if the connections occur at regular intervals (e.g., every ~5 seconds).
    
- Notice if the amount of data transferred is very similar across connections.
    

*Why this matters*: A host making hundreds of near-identical connections at consistent intervals is unlikely to be normal behavior — it’s a classic sign of beaconing malware.

* * *

## Example 2: Detecting DNS Exfiltration

Attackers sometimes hide stolen data inside **DNS queries**, by encoding the data into subdomain names. Zeek logs every query in `dns.log`.

`cat dns.log | /usr/local/zeek/bin/zeek-cut query | cut -d . -f1-7`

- `cat dns.log` → Prints all DNS queries recorded by Zeek.
    
- `zeek-cut query` → Extracts only the `query` field (the domain names requested).
    
- `cut -d . -f1-7` → Trims domains to their first 7 sections for readability.
    

**How to detect DNS tunneling/exfiltration:**

- Spot domains that generate **lots of unique subdomains**.
    
- Look for subdomains with **long, random strings** (often base32/base64 encoded data).
    
- Compare with normal DNS behavior: legitimate domains usually reuse a few subdomains, not hundreds.
    

*Why this matters*: A flood of encoded subdomain requests to the same parent domain is a strong indication of data being exfiltrated via DNS.

* * *

## Example 3: Detecting TLS Exfiltration

Even though TLS encrypts traffic, Zeek still records metadata in `conn.log` and `ssl.log`. This lets us detect abnormal **volume and patterns** of encrypted transfers.

Here’s a one-liner pipeline to summarize outbound data:

```
cat conn.log | \
/usr/local/zeek/bin/zeek-cut id.orig_h id.resp_h orig_bytes | \
sort | grep -v -e '^$' | grep -v '-' | \
datamash -g 1,2 sum 3 | sort -k 3 -rn | head -10

```

Let’s break it down:

- `zeek-cut id.orig_h id.resp_h orig_bytes` → Extracts the source IP, destination IP, and number of bytes sent.
    
- `sort` → Sorts the lines to prepare for grouping.
    
- `grep -v -e '^$'` → Removes empty lines.
    
- `grep -v '-'` → Removes entries where fields are missing (`-`).
    
- `datamash -g 1,2 sum 3` → Groups by source/destination pair (fields 1 and 2) and sums the bytes sent (field 3).
    
- `sort -k 3 -rn` → Sorts results numerically (`-n`) in reverse (`-r`), so the largest byte counts appear first.
    
- `head -10` → Displays the top 10 largest transfers.
    

**How to detect TLS exfiltration:**

- Look for an internal host sending unusually large volumes of data to a single external server.
    
- Compare with expected usage (e.g., legitimate HTTPS traffic typically involves browsing patterns, not steady multi-hundred MB transfers).
    

*Why this matters*: If one endpoint suddenly uploads hundreds of MBs to an unknown TLS server, that’s a strong red flag.

* * *

## Example 4: Detecting PsExec Activity

**PsExec** is a Windows administration tool often abused by attackers for lateral movement. It relies on SMB and RPC traffic, which Zeek captures in multiple logs:

- `smb_files.log` → Tracks files accessed via SMB.
    
- `smb_mapping.log` → Records share mappings (e.g., `ADMIN$`, `IPC$`).
    
- `dce_rpc.log` → Logs RPC calls such as creating and starting services.  
    <br/>
    

`cat smb_files.log` Reveals suspicious SMB file transfers, e.g. `PSEXESVC.exe` being written to `ADMIN$`.  
<br/>

`cat dce_rpc.log`  Shows service creation/start commands over RPC (e.g., `CreateService`, `StartService`).

&nbsp;

`cat smb_mapping.log`  Confirms the attacker mapped the `ADMIN$` and `IPC$` shares to carry out PsExec execution.

\*\*  
How to detect PsExec:\*\*

- Look for file transfers involving `PSEXESVC.exe`.
    
- Match with service creation events in `dce_rpc.log`.
    
- Spot use of privileged SMB shares.
    

*Why this matters*: The combination of these logs paints the entire attack chain — PsExec deployment, execution, and cleanup — making it easy to detect malicious remote code execution.

* * *

Zeek’s power lies in **turning raw traffic into searchable, structured logs**. By combining fields across different logs and using simple command-line tools (`zeek-cut`, `grep`, `datamash`, `sort`), you can:

- Detect beaconing malware
    
- Identify DNS tunneling attempts
    
- Expose suspicious encrypted exfiltration
    
- Recognize lateral movement tools like PsExec
    

This workflow doesn’t just catch intrusions — it also helps analysts **understand attacker behavior step by step**.

&nbsp;