---
title: 03. Suricata Rule Development
updated: 2025-09-22 03:18:51Z
created: 2025-09-22 02:21:45Z
---

**Rule template (memorize):**

```
<action> <proto> <src_ip> <src_port> <dir> <dst_ip> <dst_port> (
  msg:"<what & why>";
  flow:<established|to_server|to_client|from_client|from_server>;
  <one or more sticky buffers, e.g., http.method; http.uri; http.header;>
  content:"<needle>"; nocase; fast_pattern;
  offset:<n>; depth:<n>; distance:<n>; within:<n>;
  dsize:<=|>=|<>|: exact_size>;
  pcre:"/<regex>/<flags>";
  classtype:<class>; priority:<1..5>;
  reference:url,<url>; sid:<unique>; rev:<n>;
)

```

**Header (left of the parentheses):**

- **action:** `alert | log | pass | drop | reject`
    
- **proto:** `tcp | udp | icmp | ip | http | tls | dns | smb | smtp | ftp | ssh …`
    
- **IPs/ports:** use vars like `$HOME_NET`, `$EXTERNAL_NET`, `$HTTP_PORTS`, or literals (CIDR OK).
    
- **Direction:** `->` one way, `<>` bidirectional.
    
- **Port lists:** `[80,443,8000:9000,!8080]` (ranges & negation).
    

**Must-know options:**

- **msg:** clear, specific message (family, behavior, artifact).
    
- **flow:** scope your match (e.g., `established,to_server` for HTTP requests).
    
- **Sticky buffers (HTTP examples):**  
    `http.method;` `http.uri;` `http.request_line;` `http.header;` `http.header_names;`  
    `http.user_agent;` `http.cookie;` `http.host;` `http.accept;`
    
- **content:** exact bytes (use hex `|0d 0a|`, combine with `nocase`, `fast_pattern`).
    
- **Positioning:** `offset`, `depth` (from buffer start); `distance`, `within` (from last match).
    
- **Analytics:** `dsize`, `urilen`, `isdataat` (presence/length tests).
    
- **PCRE:** `pcre:"/<regex>/<flags>";`  
    common flags: `i` (case-insensitive), `m` (multi-line), `s` (dot matches newline), `U` (ungreedy).  
    IDS anchors often used: `R` (relative to last cursor), `P` (start-of-buffer). `!` inverts match.
    
- **Metadata:** `sid` (your unique ID), `rev` (rule version), `classtype`, `priority`, `reference`.
    

**Performance tips:**

- Use **sticky buffers** so Suricata searches **just** that field.
    
- Put a small, rare **content with `fast_pattern;`** early.
    
- Keep **PCRE** short, anchored (`^` / `$`), and **after** cheap `content` when possible.
    
- Constrain with **`flow`** and **ports** to cut false positives (FPs).
    
- Prefer **`dsize/urilen`** gates and **`offset/depth`** windows to avoid scanning whole payloads.
    

* * *

## 1) The Manual 

### A. Rule anatomy (mental model)

A rule has two parts:

1.  **Header**: where & when to look (action, protocol, src/dst, ports, direction).
    
2.  **Options**: what to look for & what to log (msg/content/PCRE/flow/metadata).
    

Suricata decodes protocols → builds **buffers** (e.g., HTTP URI, Cookie). When you set a buffer (e.g., `http.uri;`) it becomes **sticky** until you switch to another buffer. All following `content`/`pcre` act in that buffer.

### B. Flow/state keywords (pick what fits the traffic leg)

- `established` (TCP handshake done) — reduces noise.
    
- `to_server` / `from_client` — synonyms in HTTP request phase.
    
- `to_client` / `from_server` — response phase.
    
- Combine: `flow:established,to_server;`
    

### C. Matching primitives

- **content**: exact bytes/strings. Mix ASCII + hex:  
    `content:".php|20|HTTP|2f|1.1|0d 0a|Cookie|3a 20|";`
    
- **nocase**: case-insensitive content compare.
    
- **offset/depth**: window from buffer start (like slice `[offset:offset+depth]`).
    
- **distance/within**: window **after the previous match** (cursor moves).
    
- **dsize** (packet payload size) & **urilen** (HTTP URI length) for behavior cues.
    
- **pcre**: only when you truly need pattern logic. Anchor and keep small.  
    Example: `pcre:"/^(login\/process|admin\/get|news)\.php$/RUi";`
    

### D. HTTP quick buffers (most used)

- Requests: `http.method; http.uri; http.request_line; http.header; http.header_names; http.user_agent; http.cookie; http.host;`
    
- Responses: `http.response_line; http.header; http.set_cookie; http.server;`
    

> Tip: `http.header_names;` lets you check for `content:!"Referer";` quickly.

### E. Metadata & management

- **msg**: put family + behavior + hint (e.g., “Empire outbound cookie b64”).
    
- **sid**: keep your own high range to avoid collisions (commonly ≥ 1,000,000 for local).
    
- **rev**: bump when you change logic.
    
- **classtype/priority**: helps triage (e.g., `classtype:trojan-activity; priority:1;`).
    
- **reference**: `reference:url,example.com/writeup;`
    

### F. Tuning & FP control

- Constrain **scope** (net/ports/flow).
    
- Require **two+ indicators** (e.g., URI **and** Cookie **and** UA).
    
- Use **negative content** (`content:!"Accept";`) to exclude benigns.
    
- Gate with **dsize** or **detection_filter** for periodic/beacon patterns:
    
    - `detection_filter:track by_src, count 4, seconds 10;`

### G. Test without pcaps (local, quick)

1.  **Compile-test** your rules:

```
sudo suricata -T -c /etc/suricata/suricata.yaml -S /path/to/local.rules
```

2.  **Run live** on an interface (IDS mode):

```
sudo suricata -i <iface> -c /etc/suricata/suricata.yaml -S /path/to/local.rules
# logs in /var/log/suricata (eve.json, fast.log)

```

&nbsp;

* * *

## 2) Worked Examples (plus traffic you can generate)

> All examples assume you’re running Suricata on a box that can see your HTTP traffic (local interface or a simple two-VM lab). Replace `10.10.10.10` with any reachable web server (even `python3 -m http.server`).

### Example A — PowerShell Empire (outbound GET + b64 cookie + UA)

**Rule (condensed & efficient):**

```
alert http $HOME_NET any -> $EXTERNAL_NET any (
  msg:"Empire outbound pattern: GET / <b64 cookie> UA Win7";
  flow:established,to_server;
  http.method; content:"GET";
  http.uri; content:"/"; depth:1;
  http.cookie; content:"session="; pcre:"/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=|[A-Za-z0-9+\/]{4})$/Ri";
  http.user_agent; content:"Mozilla/5.0 (Windows NT 6.1"; http.start;
  http.header_names; content:!".php"; content:!"Referer"; content:!"Accept";
  sid:10000001; rev:1; classtype:trojan-activity; priority:1;
)

```

**Why it works:**

- Scopes to HTTP **request** path (`to_server`, method GET, URI `/`).
    
- Looks for **base64** cookie in `http.cookie` starting `session=`.
    
- Matches a **Windows 7-like UA** string.
    
- Excludes noisy headers with **negative content**.
    

**Simulate the hit (no pcap):**

```
# Start a simple HTTP server (in another terminal):
python3 -m http.server 8000

# Generate a base64-ish cookie and a GET to "/"
curl -v http://127.0.0.1:8000/ \
  -H 'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64)' \
  -H 'Cookie: session=QUJDREVGRw=='     # "ABCDEFG" -> b64

```

Check `fast.log` / `eve.json` for the alert.

* * *

### Example B — Covenant (body marker + rate)

**(inefficient on purpose, shows post-filtering)**

```
alert tcp any any -> $HOME_NET any (
  msg:"Covenant variant: HTML title burst";
  content:"<title>Hello World!</title>";
  detection_filter:track by_src, count 4, seconds 10;
  sid:10000002; rev:1; priority:1; classtype:trojan-activity;
)

```

**Key ideas to remember:**

- Uses **plain TCP** payload search (no HTTP buffers) → broader / noisier.
    
- Tames noise with a **detection_filter** (≥4 hits in 10s per source).
    

**Simulate the hit:**

```
# Simple listener to receive HTTP-like data
nc -l 8080 >/dev/null &
# Send 4 requests in <10s that include the title in body
for i in {1..4}; do
  printf 'POST / HTTP/1.1\r\nHost: 127.0.0.1\r\nContent-Length: 28\r\n\r\n<title>Hello World!</title>' \
  | nc 127.0.0.1 8080
done

```

> **Tip:** show you can convert this into a **better** rule by scoping to HTTP buffers and response phase if that’s where the string really lives (e.g., `flow:to_client; http.header;` or `http.response_line;`).

* * *

### Example C — Covenant (analytics only)

```
alert tcp $HOME_NET any -> any any (
  msg:"Covenant beacon: exact dsize 312, 3+ in 10s";
  dsize:312;
  detection_filter:track by_src, count 3, seconds 10;
  sid:10000003; rev:1; priority:1; classtype:trojan-activity;
)

```

&nbsp;

* * *

### Example D — Sliver (URI pattern + POST)

```
alert http any any -> any any (
  msg:"Sliver C2 POST to suspicious PHP endpoint";
  flow:established,to_server;
  http.method; content:"POST";
  http.uri; pcre:"/\/(php|api|upload|actions|rest|v1|oauth2callback|authenticate|oauth2|oauth|auth|database|db|namespaces)\/.*((login|signin|api|samples|rpc|index|admin|register|sign-up)\.php)\?[a-z_]{1,2}=[a-z0-9]{1,10}/Ri";
  sid:10000007; rev:1; classtype:trojan-activity; priority:3;
)

```

**Simulate:**

```
curl -v 'http://127.0.0.1:8000/api/index.php?a=deadbeef' -X POST

```

**Cookie variant (Set-Cookie in response)**  
If you run both client & server, you can still test with a simple manual response:

```
# Fake server that always replies with Set-Cookie: PHPSESSID=<32hex>;
while true; do
  { printf 'HTTP/1.1 200 OK\r\nSet-Cookie: PHPSESSID=0123456789abcdef0123456789abcdef;\r\nContent-Length: 2\r\n\r\nOK'; } | nc -l 9000; done

```

Rule:

```
alert http any any -> any any (
  msg:"Sliver-like response cookie name/value";
  flow:established,to_client;
  http.set_cookie; content:"Set-Cookie"; 
  pcre:"/(PHPSESSID|SID|SSID|APISID|csrf-state|AWSALBCORS)=[A-Za-z0-9]{32};/Ri";
  sid:10000008; rev:1; priority:3;
)

```

* * *

## 3) Extra details

**Common variables:**

```
# suricata.yaml
vars:
  address-groups:
    HOME_NET: "[10.0.0.0/8,192.168.0.0/16]"
    EXTERNAL_NET: "!$HOME_NET"
  port-groups:
    HTTP_PORTS: "80,8080,8000,3128,443"

```

**Negation & lists in header:**

`alert tcp $EXTERNAL_NET any -> $HOME_NET [80,8080,!8081] ( ... )`

**Heuristics without payload:**

- **TLS:** `alert tls any any -> $EXTERNAL_NET any (tls.sni; content:"example.com"; nocase; ...)`
    
- **DNS:** `alert dns any any -> any 53 (dns.query; content:"update.example.com"; nocase; ...)`
    

**`fast_pattern` usage:**

`http.uri; content:"/saveInstallation.action"; fast_pattern; # short, selective`

**Anchoring PCRE for speed & precision:**

`pcre:"/^session=[A-Za-z0-9+\/=]{8,100}$/Ri"; # ^ and $ restrict the search`

**When rules misfire (quick triage steps):**

- Confirm buffer (e.g., using `http.uri;` vs `http.header;`).
    
- Reduce scope (add `flow`, ports, `HOME_NET`).
    
- Add a second indicator or a **negative** header check.
    
- Move heavy `pcre` **after** a cheap `content` gate.
    

**Rule lifecycle hygiene:**

- Keep a local range for SIDs (e.g., ≥1,000,000).
    
- Increment `rev` on logic changes.
    
- Comment your rules with the *why* and test notes.
    

* * *

## 4) Minimal “from zero” practice flow (no pcaps)

1.  **Create** `/etc/suricata/rules/local.rules` with one example rule above.
    
2.  **Enable** it in `suricata.yaml` (`rule-files: [local.rules]`).
    
3.  **Compile-test**:
    

`sudo suricata -T -c /etc/suricata/suricata.yaml -S /etc/suricata/rules/local.rules`

4.  **Start Suricata** on your interface:

`sudo suricata -i eth0 -c /etc/suricata/suricata.yaml -S /etc/suricata/rules/local.rules`

5.  **Generate traffic** with the given `curl`/`nc` one-liners.
    
6.  **Read alerts**:
    

```
sudo tail -f /var/log/suricata/fast.log
# or jq eve.json:
sudo jq 'select(.event_type=="alert") | .alert' /var/log/suricata/eve.json

```

* * *

&nbsp;