---
title: 04. Suricata Rule Dev. (Encrypted Traffic)
updated: 2025-09-25 03:41:23Z
created: 2025-09-22 03:17:38Z
---

# Suricata Rule Development (Part 2: Encrypted Traffic)

## Why Encrypted Traffic is a Challenge

Most modern traffic is encrypted (HTTPS/TLS). IDS/IPS tools like **Suricata** cannot easily inspect payloads inside encrypted tunnels.  
**Instead, we detect based onÂ metadata that remains unencrypted during the handshake.**

### Two key detection methods:

1.  **SSL/TLS Certificate Analysis**
    
    - Certificates exchanged during TLS handshake reveal:
        
        - **Issuer** (who issued the cert)
            
        - **Validity** (issue/expiry date)
            
        - **Subject** (domain name, org info, etc.)
            
    - Malicious domains often use **odd or suspicious certificates** (self-signed, mismatched CN, unusual issuers).
        
2.  **JA3 Fingerprinting**
    
    - **JA3** creates a unique hash of the **TLS Client Hello**.
        
    - Different malware families use distinct TLS stacks â†’ unique **JA3 digests**.
        
    - Matching known malicious JA3 hashes = detect encrypted C2 traffic.
        

* * *

## Suricata TLS Rule Basics

Suricata supports **`tls` keyword** for rules:

`alert tls <SRC_IP> <SRC_PORT> -> <DST_IP> <DST_PORT> (options)`

- **`alert tls`** â†’ applies to TLS traffic.
    
- Can match **cert fields** or **JA3 hashes**.
    

* * *

## Example 1: Dridex (Malicious Certificate Detection)

```
alert tls $EXTERNAL_NET any -> $HOME_NET any \
(msg:"ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex)"; \
flow:established,from_server; \
content:"|16|"; content:"|0b|"; within:8; \
content:"|03 02 01 02 02 09 00|"; fast_pattern; \
content:"|30 09 06 03 55 04 06 13 02|"; distance:0; pcre:"/^[A-Z]{2}/R"; \
content:"|55 04 07|"; distance:0; \
content:"|55 04 0a|"; distance:0; \
content:"|55 04 03|"; distance:0; byte_test:1,>,13,1,relative; \
content:!"www."; distance:2; within:4; \
sid:2023476; rev:5;)

```

### Breakdown of key parts

- **`content:"|16|"` & `content:"|0b|" within:8`** â†’ match TLS handshake record (0x16) and certificate message (0x0b).
    
- **`content:"|03 02 01 02 02 09 00|" fast_pattern`** â†’ unique byte sequence in Dridex certs.
    
- **`content:"|30 09 06 03 55 04 06 13 02|"` + `pcre:"/^[A-Z]{2}/R"`**  
    â†’ looks for **countryName (OID 2.5.4.6)** in subject; must be **2 uppercase letters** (valid country code).
    
- **`content:"|55 04 07|"`** â†’ localityName (OID 2.5.4.7).
    
- **`content:"|55 04 0a|"`** â†’ organizationName (OID 2.5.4.10).
    
- **`content:"|55 04 03|"` + `byte_test:1,>,13`** â†’ commonName (OID 2.5.4.3), must be longer than 13 bytes.
    
- **`content:!"www."`** â†’ excludes certificates starting with â€œwww.â€
    
- **`sid:2023476; rev:5;`** â†’ unique rule ID and revision.
    

ðŸ‘‰ This detects Dridex C2 by looking at **abuse.châ€™s SSL blacklist indicators**.

* * *

## Example 2: Sliver (JA3 Hash Detection)

```
alert tls any any -> any any \
(msg:"Sliver C2 SSL"; \
ja3.hash; content:"473cd7cb9faa642487833865d516e578"; \
sid:1002; rev:1;)

```

### Breakdown

- **`alert tls`** â†’ applies to TLS traffic.
    
- **`ja3.hash`** â†’ enables Suricata to inspect JA3 fingerprint.
    
- **`content:"473cd7cb9faa642487833865d516e578"`** â†’ known Sliver JA3 digest.
    
- **`sid:1002; rev:1;`** â†’ rule metadata.
    

ðŸ‘‰ This fires when any TLS session matches the **Sliver JA3 fingerprint**.

* * *

## Workflow for Using These Rules

1.  **Uncomment / Add rules** in `local.rules`:
    
    - Located in `/etc/suricata/rules/` or in lab: `/home/htb-student/local.rules`.
2.  **Run Suricata on a PCAP**:
    

- `sudo suricata -r /path/to/file.pcap -l . -k none`
    
    - `-r` â†’ read packets from file.
        
    - `-l .` â†’ log to current directory.
        
    - `-k none` â†’ disable checksum verification.
        
- **Check alerts in `fast.log`:**
    

1.  `cat fast.log`
    
    - Lists timestamps, rule message, priority, IPs/ports.

* * *

## OID Quick Reference (X.509 Certificate Fields)

- **2.5.4.6 â†’ countryName**
    
- **2.5.4.7 â†’ localityName**
    
- **2.5.4.10 â†’ organizationName**
    
- **2.5.4.3 â†’ commonName**
    

* * *

## Exam Cheat Sheet Summary

ðŸ”¹ **Encrypted traffic detection = metadata analysis**

- Certificates: issuer, CN, OIDs, anomalies.
    
- JA3 hash: fingerprint of TLS client â†’ matches malware families.
    

ðŸ”¹ **Key Rule Components**

- `alert tls` â†’ triggers on TLS flows.
    
- `content:"|16|"; content:"|0b|"; within:8;` â†’ TLS handshake + cert.
    
- `ja3.hash; content:"<hash>"` â†’ match JA3 digest.
    
- `sid:<id>; rev:<n>;` â†’ rule metadata.
    

ðŸ”¹ **Common Tools**

- `suricata -r file.pcap -l . -k none` â†’ run Suricata on pcap.
    
- `cat fast.log` â†’ view alerts.
    
- `ja3 -a --json file.pcap` â†’ calculate JA3 hashes.
    

* * *

&nbsp;