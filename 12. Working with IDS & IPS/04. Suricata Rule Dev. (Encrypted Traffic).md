---
title: 04. Suricata Rule Dev. (Encrypted Traffic)
updated: 2025-09-25 03:41:23Z
created: 2025-09-22 03:17:38Z
---

# Suricata Rule Development (Part 2: Encrypted Traffic)

## Why Encrypted Traffic is a Challenge

Most modern traffic is encrypted (HTTPS/TLS). IDS/IPS tools like **Suricata** cannot easily inspect payloads inside encrypted tunnels.  
**Instead, we detect based on metadata that remains unencrypted during the handshake.**

### Two key detection methods:

1.  **SSL/TLS Certificate Analysis**
    
    - Certificates exchanged during TLS handshake reveal:
        
        - **Issuer** (who issued the cert)
            
        - **Validity** (issue/expiry date)
            
        - **Subject** (domain name, org info, etc.)
            
    - Malicious domains often use **odd or suspicious certificates** (self-signed, mismatched CN, unusual issuers).
        
2.  **JA3 Fingerprinting**
    
    - **JA3** creates a unique hash of the **TLS Client Hello**.
        
    - Different malware families use distinct TLS stacks → unique **JA3 digests**.
        
    - Matching known malicious JA3 hashes = detect encrypted C2 traffic.
        

* * *

## Suricata TLS Rule Basics

Suricata supports **`tls` keyword** for rules:

`alert tls <SRC_IP> <SRC_PORT> -> <DST_IP> <DST_PORT> (options)`

- **`alert tls`** → applies to TLS traffic.
    
- Can match **cert fields** or **JA3 hashes**.
    

* * *

## Example 1: Dridex (Malicious Certificate Detection)

```
alert tls $EXTERNAL_NET any -> $HOME_NET any \
(msg:"ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex)"; \
flow:established,from_server; \
content:"|16|"; content:"|0b|"; within:8; \
content:"|03 02 01 02 02 09 00|"; fast_pattern; \
content:"|30 09 06 03 55 04 06 13 02|"; distance:0; pcre:"/^[A-Z]{2}/R"; \
content:"|55 04 07|"; distance:0; \
content:"|55 04 0a|"; distance:0; \
content:"|55 04 03|"; distance:0; byte_test:1,>,13,1,relative; \
content:!"www."; distance:2; within:4; \
sid:2023476; rev:5;)

```

### Breakdown of key parts

- **`content:"|16|"` & `content:"|0b|" within:8`** → match TLS handshake record (0x16) and certificate message (0x0b).
    
- **`content:"|03 02 01 02 02 09 00|" fast_pattern`** → unique byte sequence in Dridex certs.
    
- **`content:"|30 09 06 03 55 04 06 13 02|"` + `pcre:"/^[A-Z]{2}/R"`**  
    → looks for **countryName (OID 2.5.4.6)** in subject; must be **2 uppercase letters** (valid country code).
    
- **`content:"|55 04 07|"`** → localityName (OID 2.5.4.7).
    
- **`content:"|55 04 0a|"`** → organizationName (OID 2.5.4.10).
    
- **`content:"|55 04 03|"` + `byte_test:1,>,13`** → commonName (OID 2.5.4.3), must be longer than 13 bytes.
    
- **`content:!"www."`** → excludes certificates starting with “www.”
    
- **`sid:2023476; rev:5;`** → unique rule ID and revision.
    

👉 This detects Dridex C2 by looking at **abuse.ch’s SSL blacklist indicators**.

* * *

## Example 2: Sliver (JA3 Hash Detection)

```
alert tls any any -> any any \
(msg:"Sliver C2 SSL"; \
ja3.hash; content:"473cd7cb9faa642487833865d516e578"; \
sid:1002; rev:1;)

```

### Breakdown

- **`alert tls`** → applies to TLS traffic.
    
- **`ja3.hash`** → enables Suricata to inspect JA3 fingerprint.
    
- **`content:"473cd7cb9faa642487833865d516e578"`** → known Sliver JA3 digest.
    
- **`sid:1002; rev:1;`** → rule metadata.
    

👉 This fires when any TLS session matches the **Sliver JA3 fingerprint**.

* * *

## Workflow for Using These Rules

1.  **Uncomment / Add rules** in `local.rules`:
    
    - Located in `/etc/suricata/rules/` or in lab: `/home/htb-student/local.rules`.
2.  **Run Suricata on a PCAP**:
    

- `sudo suricata -r /path/to/file.pcap -l . -k none`
    
    - `-r` → read packets from file.
        
    - `-l .` → log to current directory.
        
    - `-k none` → disable checksum verification.
        
- **Check alerts in `fast.log`:**
    

1.  `cat fast.log`
    
    - Lists timestamps, rule message, priority, IPs/ports.

* * *

## OID Quick Reference (X.509 Certificate Fields)

- **2.5.4.6 → countryName**
    
- **2.5.4.7 → localityName**
    
- **2.5.4.10 → organizationName**
    
- **2.5.4.3 → commonName**
    

* * *

## Exam Cheat Sheet Summary

🔹 **Encrypted traffic detection = metadata analysis**

- Certificates: issuer, CN, OIDs, anomalies.
    
- JA3 hash: fingerprint of TLS client → matches malware families.
    

🔹 **Key Rule Components**

- `alert tls` → triggers on TLS flows.
    
- `content:"|16|"; content:"|0b|"; within:8;` → TLS handshake + cert.
    
- `ja3.hash; content:"<hash>"` → match JA3 digest.
    
- `sid:<id>; rev:<n>;` → rule metadata.
    

🔹 **Common Tools**

- `suricata -r file.pcap -l . -k none` → run Suricata on pcap.
    
- `cat fast.log` → view alerts.
    
- `ja3 -a --json file.pcap` → calculate JA3 hashes.
    

* * *

&nbsp;